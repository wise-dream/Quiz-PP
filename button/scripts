#!/bin/bash
# –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å ESP32-C3 Quiz Button
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: source scripts  –∏–ª–∏  . scripts

# ============================================
# –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´
# ============================================

# –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ª–∏–≤–∫–∞ production –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
build_upload_prod() {
  echo "üî® –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ª–∏–≤–∫–∞ PRODUCTION –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
  pio run -e quiz_button_prod -t upload
}

# –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ª–∏–≤–∫–∞ test –æ–∫—Ä—É–∂–µ–Ω–∏—è
build_upload_test() {
  echo "üî® –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ª–∏–≤–∫–∞ TEST –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
  pio run -e quiz_button_test -t upload
}

# –¢–æ–ª—å–∫–æ —Å–±–æ—Ä–∫–∞ (–±–µ–∑ –∑–∞–ª–∏–≤–∫–∏)
build() {
  echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
  pio run
}

# –¢–æ–ª—å–∫–æ –∑–∞–ª–∏–≤–∫–∞ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç —á—Ç–æ —Å–±–æ—Ä–∫–∞ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞)
upload() {
  echo "üì§ –ó–∞–ª–∏–≤–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏..."
  pio run -t upload
}

# –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
clean() {
  echo "üßπ –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
  pio run -t clean
}

# ============================================
# –ú–û–ù–ò–¢–û–†–ò–ù–ì –ò –û–¢–õ–ê–î–ö–ê
# ============================================

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Serial –ø–æ—Ä—Ç–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ª–æ–≥–æ–≤
monitor() {
  echo "üì∫ –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ Serial –ø–æ—Ä—Ç–∞ (Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞)..."
  pio device monitor
}

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º —Ç–æ–ª—å–∫–æ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
monitor_http() {
  echo "üì∫ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ (Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞)..."
  pio device monitor | grep -E "HTTP|REQUEST|RESPONSE|BUTTON"
}

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏
monitor_timestamped() {
  echo "üì∫ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏ (Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞)..."
  pio device monitor | while IFS= read -r line; do
    echo "[$(date +'%H:%M:%S')] $line"
  done
}

# ============================================
# –ò–ù–§–û–†–ú–ê–¶–ò–Ø –ò –°–¢–ê–¢–£–°
# ============================================

# –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π
list_envs() {
  echo "üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
  pio run --list-targets
}

# –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
device_info() {
  echo "üì± –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ:"
  pio device list
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
check_device() {
  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞..."
  if pio device list | grep -q "/dev/ttyACM0"; then
    echo "‚úÖ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–∞ /dev/ttyACM0"
  else
    echo "‚ùå –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"
  fi
}

# ============================================
# –ë–´–°–¢–†–´–ï –ö–û–ú–ê–ù–î–´
# ============================================

# –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: –æ—á–∏—Å—Ç–∫–∞ -> —Å–±–æ—Ä–∫–∞ -> –∑–∞–ª–∏–≤–∫–∞ -> –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
full_deploy() {
  echo "üöÄ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è..."
  clean
  build_upload_prod
  sleep 2
  monitor
}

# –ë—ã—Å—Ç—Ä–∞—è —Å–±–æ—Ä–∫–∞ –∏ –∑–∞–ª–∏–≤–∫–∞ (–±–µ–∑ –æ—á–∏—Å—Ç–∫–∏)
quick_deploy() {
  echo "‚ö° –ë—ã—Å—Ç—Ä–∞—è –∑–∞–ª–∏–≤–∫–∞..."
  build_upload_prod
}

# ============================================
# –ê–õ–ò–ê–°–´ –î–õ–Ø –£–î–û–ë–°–¢–í–ê
# ============================================

alias b="build"
alias u="upload"
alias m="monitor"
alias bp="build_upload_prod"
alias bt="build_upload_test"
alias fd="full_deploy"
alias qd="quick_deploy"

# ============================================
# –°–ü–†–ê–í–ö–ê
# ============================================

show_help() {
  echo "ESP32-C3 Quiz Button - –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
  echo ""
  echo "–°–±–æ—Ä–∫–∞ –∏ –∑–∞–ª–∏–≤–∫–∞:"
  echo "  build_upload_prod   - –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ª–∏–≤–∫–∞ PRODUCTION"
  echo "  build_upload_test    - –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ª–∏–≤–∫–∞ TEST"
  echo "  build                - –¢–æ–ª—å–∫–æ —Å–±–æ—Ä–∫–∞"
  echo "  upload               - –¢–æ–ª—å–∫–æ –∑–∞–ª–∏–≤–∫–∞"
  echo "  clean                - –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞"
  echo ""
  echo "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:"
  echo "  monitor              - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Serial –ø–æ—Ä—Ç–∞"
  echo "  monitor_http         - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ–ª—å–∫–æ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤"
  echo "  monitor_timestamped  - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏"
  echo ""
  echo "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
  echo "  list_envs            - –°–ø–∏—Å–æ–∫ –æ–∫—Ä—É–∂–µ–Ω–∏–π"
  echo "  device_info          - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ"
  echo "  check_device         - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
  echo ""
  echo "–ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
  echo "  full_deploy          - –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª (clean + build + upload + monitor)"
  echo "  quick_deploy         - –ë—ã—Å—Ç—Ä–∞—è –∑–∞–ª–∏–≤–∫–∞"
  echo ""
  echo "–ê–ª–∏–∞—Å—ã:"
  echo "  b, u, m              - build, upload, monitor"
  echo "  bp, bt               - build_upload_prod, build_upload_test"
  echo "  fd, qd               - full_deploy, quick_deploy"
}

# –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
echo "‚úÖ –°–∫—Ä–∏–ø—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'show_help' –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏."
