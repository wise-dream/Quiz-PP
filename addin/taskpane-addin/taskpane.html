<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Quiz Host</title>
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https: wss:; connect-src https: wss:;
                 img-src https: data:; style-src 'self' 'unsafe-inline' https:;
                 script-src 'self' https: 'unsafe-inline';">
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è PowerPoint taskpane (320x531px) */
    body {
      margin: 0;
      padding: 8px;
      font: 13px/1.3 system-ui, Segoe UI, Roboto, Arial;
      width: 304px; /* 320px - 16px padding */
      box-sizing: border-box;
    }
    
    button {
      padding: 6px 10px;
      margin: 4px 4px 0 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
      min-height: 28px;
    }
    
    button:hover { background: #f5f5f5 }
    button:disabled { opacity: 0.6; cursor: not-allowed }
    
    button.activate { background: #dc3545; color: white; border-color: #dc3545 }
    button.activate:hover { background: #c82333 }
    button.deactivate { background: #28a745; color: white; border-color: #28a745 }
    button.deactivate:hover { background: #218838 }
    
    .row { margin: 6px 0 }
    .status { margin: 6px 0; padding: 4px 6px; border-radius: 4px; font-size: 11px }
    .status.connected { background: #d4edda; color: #155724 }
    .status.disconnected { background: #f8d7da; color: #721c24 }
    .status.connecting { background: #fff3cd; color: #856404 }
    
    input {
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin: 0 2px;
      font-size: 12px;
      height: 24px;
    }
    
    .phase-info {
      margin: 6px 0;
      padding: 6px;
      background: #f8f9fa;
      border-radius: 4px;
      border-left: 4px solid #007bff;
      font-size: 11px;
    }
    
    .players-list {
      margin: 6px 0;
      max-height: 120px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 11px;
    }
    
    .player-item {
      padding: 3px 6px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
    }
    .player-item:last-child { border-bottom: none }
    
    .quiz-controls {
      margin: 8px 0;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #dee2e6;
    }
    
    .quiz-controls h3 {
      margin: 0 0 6px 0;
      font-size: 14px;
      color: #495057;
    }
    
    .timer-input { width: 50px }
    .note { font-size: 10px; color: #666 }
    
    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ */
    h4 {
      margin: 0 0 4px 0;
      font-size: 13px;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
    button[id*="create"], button[id*="join"] {
      width: 100%;
      margin: 2px 0;
      font-size: 11px;
    }
    
    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –ø–æ–ª—è –≤–≤–æ–¥–∞ */
    input[placeholder] {
      width: 100%;
      margin: 2px 0;
    }
  </style>
</head>
<body>
  <div class="row">
    <div style="margin-bottom: 4px;">
      <button id="create-game" style="background:#007bff;color:white;border-color:#007bff;margin-right:4px">üéÆ –°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</button>
      <button id="join-game" style="background:#6c757d;color:white;border-color:#6c757d">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
    </div>
    <div id="game-creation-section" style="display:none;margin:4px 0;padding:8px;background:#e9ecef;border-radius:4px">
      <h4 style="margin:0 0 4px 0;color:#495057">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∏–≥—Ä—ã</h4>
      <div style="margin:4px 0;font-size:10px;color:#666">
        –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –∫–æ–º–Ω–∞—Ç–∞ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º 4-—Å–∏–º–≤–æ–ª—å–Ω—ã–º –∫–æ–¥–æ–º –∏ –ø–∞—Ä–æ–ª–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
      </div>
      <div style="margin:4px 0">
        <button id="confirm-create" style="background:#28a745;color:white;border-color:#28a745">–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</button>
        <button id="cancel-create" style="background:#dc3545;color:white;border-color:#dc3545">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
    <div id="game-info-section" style="display:none;margin:4px 0;padding:8px;background:#d4edda;border-radius:4px;border-left:4px solid #28a745">
      <h4 style="margin:0 0 4px 0;color:#155724">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–≥—Ä–µ</h4>
      <div style="margin:2px 0"><strong>–ù–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã:</strong> <span id="room-code-display" style="font-family:monospace;font-size:16px;font-weight:bold;color:#007bff"></span></div>
      <div style="margin:2px 0"><strong>–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</strong> <span id="admin-password-display" style="font-family:monospace;font-size:14px;font-weight:bold;color:#dc3545"></span></div>
      <div style="margin:4px 0;font-size:10px;color:#666">
        –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –Ω–æ–º–µ—Ä–æ–º –∫–æ–º–Ω–∞—Ç—ã —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏. –ü–∞—Ä–æ–ª—å –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–π.
      </div>
      <div style="margin:4px 0">
        <button id="back-to-main" style="background:#6c757d;color:white;border-color:#6c757d">‚Üê –ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é</button>
      </div>
    </div>
    <div id="join-section" style="display:none">
      <div style="margin:4px 0">
        <label>–ù–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã:</label>
        <input id="room" value="" size="8" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã">
      </div>
      <div style="margin:4px 0">
        <label>–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</label>
        <input id="admin-password" type="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞" style="width: 100%; margin: 2px 0;">
      </div>
      <div style="margin:4px 0">
        <button id="connect">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
      </div>
      <div style="margin:4px 0">
        <button id="back-to-main-join" style="background:#6c757d;color:white;border-color:#6c757d">‚Üê –ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é</button>
      </div>
    </div>
    <div id="status" class="status disconnected">‚Äî</div>
  </div>

  <div class="quiz-controls">
    <h3>üéØ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–≤–∏–∑–æ–º</h3>
    <div class="row">
      <button id="activate-question" class="activate">üî¥ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É</button>
      <button id="activate-players" class="activate">üü¢ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É</button>
      <button id="deactivate-question" class="deactivate">‚èπÔ∏è –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É</button>
    </div>
  </div>

  <div class="quiz-controls">
    <h3>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–∞–º–∏</h3>
    <div class="row">
      <input id="team-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã" style="width: auto; margin: 2px 0;">
    </div>
    <div class="row">
      <div style="display: flex; gap: 4px; margin: 2px 0;">
        <button id="team-color-red" class="team-color-btn" style="background: #dc3545; width: 20px; height: 20px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 1px #ccc;" data-color="#dc3545"></button>
        <button id="team-color-blue" class="team-color-btn" style="background: #007bff; width: 20px; height: 20px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 1px #ccc;" data-color="#007bff"></button>
        <button id="team-color-green" class="team-color-btn" style="background: #28a745; width: 20px; height: 20px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 1px #ccc;" data-color="#28a745"></button>
        <button id="team-color-yellow" class="team-color-btn" style="background: #ffc107; width: 20px; height: 20px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 1px #ccc;" data-color="#ffc107"></button>
        <button id="team-color-purple" class="team-color-btn" style="background: #6f42c1; width: 20px; height: 20px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 1px #ccc;" data-color="#6f42c1"></button>
        <button id="team-color-orange" class="team-color-btn" style="background: #fd7e14; width: 20px; height: 20px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 1px #ccc;" data-color="#fd7e14"></button>
      </div>
    </div>
    <div class="row">
      <button id="create-team" style="background:#28a745;color:white;border-color:#28a745;width:100%;margin:2px 0;">‚ûï –°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É</button>
    </div>
    <div id="teams-list" class="players-list" style="display:none;margin-top:8px;">
      <div style="padding:4px 8px;background:#f5f5f5;font-weight:bold;border-bottom:1px solid #ddd">–ö–æ–º–∞–Ω–¥—ã:</div>
      <div id="teams-content"></div>
    </div>
  </div>

  <div class="quiz-controls">
    <h3>üîò –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏</h3>
    <div class="row" style="display: flex; gap: 4px; align-items: center;">
      <button id="refresh-buttons" style="background:#007bff;color:white;border-color:#007bff;flex: 1;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      <button id="add-button-toggle" style="background:#28a745;color:white;border-color:#28a745;flex: 1;">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div id="add-button-form" style="display:none;margin-top:8px;padding:8px;background:#f8f9fa;border-radius:4px;border:1px solid #dee2e6">
      <div style="margin-bottom:6px">
        <input id="button-mac" placeholder="MAC –∞–¥—Ä–µ—Å (AA:BB:CC:DD:EE:FF)" style="width:100%;font-size:11px;font-family:monospace">
      </div>
      <div style="margin-bottom:6px">
        <input id="button-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" style="width:100%;font-size:11px">
      </div>
      <div style="display:flex;gap:4px">
        <button id="add-button-confirm" style="background:#28a745;color:white;border-color:#28a745;flex:1;font-size:11px">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button id="add-button-cancel" style="background:#6c757d;color:white;border-color:#6c757d;flex:1;font-size:11px">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
    <div id="buttons-list" class="players-list" style="display:none;margin-top:8px;max-height:200px;overflow-y:auto;">
      <div style="padding:4px 8px;background:#f5f5f5;font-weight:bold;border-bottom:1px solid #ddd">–ö–Ω–æ–ø–∫–∏:</div>
      <div id="buttons-content"></div>
    </div>
  </div>

  <div id="phase-info" class="phase-info" style="display:none">
    <strong>–§–∞–∑–∞:</strong> <span id="current-phase">‚Äî</span><br>
    <strong>–í–∫–ª—é—á–µ–Ω–∏–µ:</strong> <span id="enable-time">‚Äî</span>
  </div>

  <div id="players-list" class="players-list" style="display:none">
    <div style="padding:4px 8px;background:#f5f5f5;font-weight:bold;border-bottom:1px solid #ddd">–ò–≥—Ä–æ–∫–∏:</div>
    <div id="players-content"></div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ -->
  <div id="answer-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000">
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:8px;min-width:300px">
      <h3 style="margin:0 0 15px 0">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞</h3>
      <p><strong>–ü–µ—Ä–≤—ã–π –æ—Ç–≤–µ—Ç:</strong> <span id="first-answerer">‚Äî</span></p>
      <p><strong>–û—Ç–≤–µ—Ç:</strong> <span id="player-answer">‚Äî</span></p>
      <div style="margin:15px 0">
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–∫–æ–≤:</label>
        <input id="points-input" type="number" value="10" min="0" max="100" style="width:80px;margin-left:10px">
      </div>
      <div style="text-align:right;margin-top:20px">
        <button id="answer-correct" style="background:#28a745;color:white;border:none;padding:8px 16px;margin-right:10px;border-radius:4px">–ü—Ä–∞–≤–∏–ª—å–Ω–æ</button>
        <button id="answer-wrong" style="background:#dc3545;color:white;border:none;padding:8px 16px;margin-right:10px;border-radius:4px">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</button>
        <button id="answer-cancel" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:4px">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

<script>
(() => {
  let ws;
  let currentRoomCode = '';
  let currentAdminPassword = '';
  let selectedTeamColor = '#dc3545'; // Default to red
  let currentRoomState = null; // Store current room state for player lookup
  
  // UI Elements
  const $room = document.getElementById('room');
  const $adminPassword = document.getElementById('admin-password');
  const $status = document.getElementById('status');
  const $phaseInfo = document.getElementById('phase-info');
  const $currentPhase = document.getElementById('current-phase');
  const $enableTime = document.getElementById('enable-time');
  const $playersList = document.getElementById('players-list');
  const $playersContent = document.getElementById('players-content');
  const $activateBtn = document.getElementById('activate-question');
  const $activatePlayersBtn = document.getElementById('activate-players');
  const $deactivateBtn = document.getElementById('deactivate-question');
  
  // Game creation elements
  const $createGameBtn = document.getElementById('create-game');
  const $joinGameBtn = document.getElementById('join-game');
  const $gameCreationSection = document.getElementById('game-creation-section');
  const $gameInfoSection = document.getElementById('game-info-section');
  const $joinSection = document.getElementById('join-section');
  const $confirmCreate = document.getElementById('confirm-create');
  const $cancelCreate = document.getElementById('cancel-create');
  const $roomCodeDisplay = document.getElementById('room-code-display');
  const $adminPasswordDisplay = document.getElementById('admin-password-display');
  const $backToMain = document.getElementById('back-to-main');
  const $backToMainJoin = document.getElementById('back-to-main-join');
  
  // –≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª–∫–∏
  const $answerModal = document.getElementById('answer-modal');
  const $firstAnswerer = document.getElementById('first-answerer');
  const $playerAnswer = document.getElementById('player-answer');
  const $pointsInput = document.getElementById('points-input');
  const $answerCorrect = document.getElementById('answer-correct');
  const $answerWrong = document.getElementById('answer-wrong');
  const $answerCancel = document.getElementById('answer-cancel');
  
  // Team management elements
  const $teamName = document.getElementById('team-name');
  const $createTeamBtn = document.getElementById('create-team');
  const $teamsList = document.getElementById('teams-list');
  const $teamsContent = document.getElementById('teams-content');
  const $teamColorBtns = document.querySelectorAll('.team-color-btn');
  
  // Button management elements
  const $refreshButtons = document.getElementById('refresh-buttons');
  const $addButtonToggle = document.getElementById('add-button-toggle');
  const $addButtonForm = document.getElementById('add-button-form');
  const $buttonMac = document.getElementById('button-mac');
  const $buttonName = document.getElementById('button-name');
  const $addButtonConfirm = document.getElementById('add-button-confirm');
  const $addButtonCancel = document.getElementById('add-button-cancel');
  const $buttonsList = document.getElementById('buttons-list');
  const $buttonsContent = document.getElementById('buttons-content');
  
  let allButtons = []; // Store buttons data

  function updateStatus(text, className) {
    $status.textContent = text;
    $status.className = `status ${className}`;
  }

  // Game creation functions
  function showCreateGameSection() {
    $gameCreationSection.style.display = 'block';
    $gameInfoSection.style.display = 'none';
    $joinSection.style.display = 'none';
    $createGameBtn.style.display = 'none';
    $joinGameBtn.style.display = 'none';
  }

  function showJoinSection() {
    $gameCreationSection.style.display = 'none';
    $gameInfoSection.style.display = 'none';
    $joinSection.style.display = 'block';
    $createGameBtn.style.display = 'none';
    $joinGameBtn.style.display = 'none';
  }

  function showMainButtons() {
    $gameCreationSection.style.display = 'none';
    $gameInfoSection.style.display = 'none';
    $joinSection.style.display = 'none';
    $createGameBtn.style.display = 'inline-block';
    $joinGameBtn.style.display = 'inline-block';
  }

  function showGameInfo(roomCode, adminPassword) {
    currentRoomCode = roomCode;
    currentAdminPassword = adminPassword;
    $roomCodeDisplay.textContent = roomCode;
    $adminPasswordDisplay.textContent = adminPassword;
    $gameInfoSection.style.display = 'block';
    $gameCreationSection.style.display = 'none';
    $joinSection.style.display = 'none';
    $createGameBtn.style.display = 'none';
    $joinGameBtn.style.display = 'none';
    
    // Load buttons when room is created/connected
    loadButtons();
  }

  function createGame() {
    // Connect to WebSocket first
    if (ws) try { ws.close(); } catch {}
    
    updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'connecting');
    
    // Connect without room parameter for creation
    const url = `wss://wise-dream.ru/quiz/ws?role=host`;
    console.log('Connecting to WebSocket:', url);
    
    try {
      ws = new WebSocket(url);
    } catch (error) {
      console.error('Failed to create WebSocket:', error);
      updateStatus('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'disconnected');
      return;
    }
    
    // Set timeout for connection
    const connectionTimeout = setTimeout(() => {
      if (ws && ws.readyState === WebSocket.CONNECTING) {
        console.error('WebSocket connection timeout');
        ws.close();
        updateStatus('–¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'disconnected');
      }
    }, 10000); // 10 seconds timeout
    
    ws.onopen = () => {
      console.log('WebSocket connected successfully');
      clearTimeout(connectionTimeout);
      updateStatus('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...', 'connecting');
      
      // Send create room event - –∏–¥–µ–Ω—Ç–∏—á–Ω–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É
      const createRoomEvent = {
        type: 'create_room'
      };
      console.log('Sending create room event:', createRoomEvent);
      ws.send(JSON.stringify(createRoomEvent));
    };
    
    ws.onclose = (event) => {
      console.log('WebSocket connection closed:', event.code, event.reason);
      clearTimeout(connectionTimeout);
      updateStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ', 'disconnected');
    };
    
    ws.onerror = (error) => {
      console.error('WebSocket error:', error);
      clearTimeout(connectionTimeout);
      updateStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'disconnected');
    };
    ws.onmessage = (ev) => {
      console.log('WebSocket message received:', ev.data);
      try {
        // Split message by newlines in case multiple JSON messages are sent
        const messages = ev.data.trim().split('\n').filter(msg => msg.trim());
        
        for (const messageText of messages) {
          const msg = JSON.parse(messageText);
          console.log('Parsed message:', msg);
          
          if (msg.type === 'room_created') {
            const roomData = msg.data;
            const adminToken = msg.adminToken;
            showGameInfo(roomData.code, adminToken);
            updateStatus('–ò–≥—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞!', 'connected');
            // Update room input for future use
            $room.value = roomData.code;
          } else if (msg.type === 'state') {
            updatePhaseInfo(msg.data);
          } else if (msg.type === 'answer_received') {
            // Handle hardware button press or regular answer
            if (msg.teamId && msg.teamName) {
              // Hardware button press - show alert
              showButtonPressAlert(msg.teamName, msg.teamId);
            } else {
              // Regular answer from player
              showAnswerModal({
                userId: msg.userId,
                answer: msg.answer
              });
            }
          } else if (msg.type === 'team_created') {
            console.log('Team created:', msg.data);
            updateStatus('–ö–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞–Ω–∞!', 'connected');
          } else if (msg.type === 'player_joined') {
            console.log('Player joined:', msg.data);
          } else if (msg.type === 'team_joined') {
            console.log('Player joined team:', msg.data);
          } else if (msg.type === 'phase_changed') {
            console.log('Phase changed to:', msg.phase);
            updateStatus(`–§–∞–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞: ${msg.phase}`, 'connected');
          } else {
            console.log('Unknown message type:', msg.type);
          }
        }
      } catch (error) {
        console.error('Error parsing WebSocket message:', error);
        console.error('Raw message:', ev.data);
        updateStatus('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö', 'disconnected');
      }
    };
  }

  function openWs() {
    const roomCode = $room.value.trim();
    const adminPassword = $adminPassword.value.trim();
    
    if (!roomCode) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã');
      return;
    }
    
    if (!adminPassword) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
      return;
    }

    // Set current room code before connection
    currentRoomCode = roomCode;

    if (ws) try { ws.close(); } catch {}
    const url = `wss://wise-dream.ru/quiz/ws?room=${encodeURIComponent(roomCode)}&role=host`;
    ws = new WebSocket(url);
    
    ws.onopen = () => {
      updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è...', 'connecting');
      
      // Send admin authentication event
      ws.send(JSON.stringify({
        type: 'admin_auth',
        roomCode: roomCode,
        password: adminPassword
      }));
    };
    
    ws.onclose = () => updateStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ', 'disconnected');
    ws.onerror = () => updateStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'disconnected');
    ws.onmessage = (ev) => {
      try {
        // Split message by newlines in case multiple JSON messages are sent
        const messages = ev.data.trim().split('\n').filter(msg => msg.trim());
        
        for (const messageText of messages) {
          const msg = JSON.parse(messageText);
          
          if (msg.type === 'state') {
            updatePhaseInfo(msg.data);
            updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', 'connected');
            // Load buttons after successful connection
            if (currentRoomCode) {
              loadButtons();
            }
          } else if (msg.type === 'error') {
            console.error('Authentication error:', msg.message);
            updateStatus('–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ' + (msg.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'), 'disconnected');
            alert('–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ' + (msg.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'));
          } else if (msg.type === 'answer_received') {
            // Handle hardware button press or regular answer
            if (msg.teamId && msg.teamName) {
              // Hardware button press - show alert
              showButtonPressAlert(msg.teamName, msg.teamId);
            } else {
              // Regular answer from player
              const answerData = msg.data || msg;
              showAnswerModal(answerData);
            }
          } else if (msg.type === 'team_created') {
            console.log('Team created:', msg.data);
            updateStatus('–ö–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞–Ω–∞!', 'connected');
          } else if (msg.type === 'player_joined') {
            console.log('Player joined:', msg.data);
          } else if (msg.type === 'team_joined') {
            console.log('Player joined team:', msg.data);
          }
        }
      } catch (error) {
        console.error('Error parsing WebSocket message:', error);
        console.error('Raw message:', ev.data);
      }
    };
  }

  function sendHostSetState(phase, delayMs) {
    if (!ws || ws.readyState !== 1) return;
    const roomCode = currentRoomCode || $room.value.trim();
    ws.send(JSON.stringify({
      type: 'host_set_state',
      quizId: roomCode,
      phase,
      ...(typeof delayMs === 'number' ? { delayMs } : {})
    }));
  }

  function updatePhaseInfo(state) {
    currentRoomState = state; // Store state for player lookup
    $currentPhase.textContent = state.phase || 'lobby';
    if (state.enableAt) {
      const enableDate = new Date(state.enableAt);
      $enableTime.textContent = enableDate.toLocaleTimeString();
      $phaseInfo.style.display = 'block';
    } else {
      $phaseInfo.style.display = 'none';
    }
    updateButtonStates(state);
    updatePlayersList(state);
    updateTeamsList(state);
    
    // Update buttons list when room state changes (teams may have changed)
    if (currentRoomCode && allButtons.length > 0) {
      updateButtonsList();
    }
  }

  function updateButtonStates(state) {
    const phase = state.phase || 'lobby';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–∞–∑—ã
    if (phase === 'lobby') {
      // –í –ª–æ–±–±–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã
      $activateBtn.style.display = 'inline-block';
      $activatePlayersBtn.style.display = 'none';
      $deactivateBtn.style.display = 'none';
      $activateBtn.textContent = 'üî¥ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É';
    } else if (phase === 'started') {
      // –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏
      $activateBtn.style.display = 'none';
      $activatePlayersBtn.style.display = 'inline-block';
      $deactivateBtn.style.display = 'none';
      $activatePlayersBtn.textContent = 'üü¢ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É';
    } else if (phase === 'active') {
      // –ö–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏
      $activateBtn.style.display = 'none';
      $activatePlayersBtn.style.display = 'none';
      $deactivateBtn.style.display = 'inline-block';
      $deactivateBtn.textContent = '‚èπÔ∏è –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É';
    } else if (phase === 'finished') {
      // –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—á–∞–ª–∞ –Ω–æ–≤–æ–π –∏–≥—Ä—ã
      $activateBtn.style.display = 'inline-block';
      $activatePlayersBtn.style.display = 'none';
      $deactivateBtn.style.display = 'none';
      $activateBtn.textContent = 'üî¥ –ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É';
    } else {
      // Fallback
      $activateBtn.style.display = 'inline-block';
      $activatePlayersBtn.style.display = 'none';
      $deactivateBtn.style.display = 'none';
      $activateBtn.textContent = 'üî¥ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É';
    }
  }

  function updatePlayersList(state) {
    const players = Object.values(state.players || {});
    if (players.length > 0) {
      $playersContent.innerHTML = players
        .filter(p => p.connected)
        .map(p => `
          <div class="player-item">
            <span>${p.name || p.userId}</span>
            <span>–ö–ª–∏–∫–∏: ${p.clickCount || 0}, –§–∞–ª—å—Å—Ç–∞—Ä—Ç—ã: ${p.falseStarts || 0}</span>
          </div>
        `).join('');
      $playersList.style.display = 'block';
    } else {
      $playersList.style.display = 'none';
    }
  }

  function updateTeamsList(state) {
    const teams = Object.values(state.teams || {});
    if (teams.length > 0) {
      $teamsContent.innerHTML = teams
        .map(team => `
          <div class="player-item">
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 12px; height: 12px; border-radius: 50%; background: ${team.color};"></div>
              <span style="font-weight: bold;">${team.name}</span>
            </div>
            <span style="font-size: 10px;">${team.players.length} –∏–≥—Ä–æ–∫–æ–≤ ‚Ä¢ ${team.score} –æ—á–∫–æ–≤</span>
          </div>
        `).join('');
      $teamsList.style.display = 'block';
    } else {
      $teamsList.style.display = 'none';
    }
  }

  function createTeam() {
    const teamName = $teamName.value.trim();
    if (!teamName) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã');
      return;
    }

    if (!ws || ws.readyState !== 1) {
      alert('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
      return;
    }

    const roomCode = currentRoomCode || $room.value.trim();
    if (!roomCode) {
      alert('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã');
      return;
    }

    // Send create team event
    ws.send(JSON.stringify({
      type: 'create_team',
      quizId: roomCode,
      teamName: teamName,
      teamColor: selectedTeamColor
    }));

    // Clear input
    $teamName.value = '';
  }

  function selectTeamColor(color) {
    selectedTeamColor = color;
    // Update visual selection
    $teamColorBtns.forEach(btn => {
      btn.style.boxShadow = btn.dataset.color === color ? '0 0 0 2px #000' : '0 0 0 1px #ccc';
    });
  }

  // Button API functions
  function getApiUrl() {
    // Use production URL
    const host = window.location.host || 'wise-dream.ru';
    const protocol = window.location.protocol || 'https:';
    return `${protocol}//${host}`;
  }

  async function buttonApiRequest(endpoint, options = {}) {
    const url = `${getApiUrl()}${endpoint}`;
    const response = await fetch(url, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...options.headers,
      },
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(errorText || `HTTP error! status: ${response.status}`);
    }

    if (response.status === 204) {
      return {};
    }

    return response.json();
  }

  // Normalize buttons array (handle object with numeric keys)
  function normalizeButtonsArray(data) {
    if (!data) return [];
    if (Array.isArray(data)) return data;
    if (typeof data === 'object') {
      const keys = Object.keys(data);
      if (keys.length > 0 && keys.every(k => /^\d+$/.test(k))) {
        return keys.map(key => data[key]).filter(Boolean);
      }
      if (data.macAddress || data.id) {
        return [data];
      }
      return Object.values(data).filter((item) => item && (item.macAddress || item.id));
    }
    return [];
  }

  // Load all buttons
  async function loadButtons() {
    if (!currentRoomCode) {
      console.log('No room code available for loading buttons');
      return;
    }

    try {
      updateStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–æ–ø–æ–∫...', 'connecting');
      const buttonsData = await buttonApiRequest('/quiz/api/button/list');
      allButtons = normalizeButtonsArray(buttonsData);
      updateButtonsList();
      updateStatus('–ö–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'connected');
    } catch (error) {
      console.error('Failed to load buttons:', error);
      updateStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–æ–ø–æ–∫', 'disconnected');
      allButtons = [];
      updateButtonsList();
    }
  }

  // Update buttons list UI
  function updateButtonsList() {
    if (!allButtons || allButtons.length === 0) {
      $buttonsList.style.display = 'none';
      return;
    }

    const roomCode = currentRoomCode;
    const teams = currentRoomState?.teams || {};

    $buttonsContent.innerHTML = allButtons.map(button => {
      const isAssignedToCurrentRoom = button.roomCode === roomCode && button.teamId;
      const assignedTeam = isAssignedToCurrentRoom && button.teamId && teams[button.teamId] 
        ? teams[button.teamId] 
        : null;
      
      const showTeamInfo = button.roomCode === roomCode && button.teamName;
      const formatMAC = (mac) => {
        const cleaned = mac.replace(/[^0-9A-F]/gi, '');
        return cleaned.match(/.{1,2}/g)?.join(':').toUpperCase() || mac.toUpperCase();
      };

      return `
        <div style="padding:6px 8px;border-bottom:1px solid #eee;font-size:11px;background:${isAssignedToCurrentRoom ? '#d4edda' : '#fff'}">
          <div style="font-weight:bold;margin-bottom:4px">${button.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
          <div style="font-family:monospace;font-size:10px;color:#666;margin-bottom:4px">${formatMAC(button.macAddress)}</div>
          ${assignedTeam ? `
            <div style="display:flex;align-items:center;gap:4px;margin-bottom:4px">
              <div style="width:10px;height:10px;border-radius:50%;background:${assignedTeam.color}"></div>
              <span style="font-size:10px">${assignedTeam.name}</span>
            </div>
          ` : showTeamInfo ? `
            <div style="font-size:10px;color:#666;margin-bottom:4px">${button.teamName}</div>
          ` : button.roomCode && button.roomCode !== roomCode ? `
            <div style="font-size:10px;color:#666;margin-bottom:4px">–ö–æ–º–Ω–∞—Ç–∞: ${button.roomCode}</div>
          ` : `
            <div style="font-size:10px;color:#999;margin-bottom:4px">–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞</div>
          `}
          <div style="display:flex;gap:2px;margin-top:4px">
            ${isAssignedToCurrentRoom ? `
              <button onclick="unassignButton('${button.macAddress}')" style="background:#dc3545;color:white;border:none;padding:2px 6px;border-radius:3px;font-size:10px;cursor:pointer;width:100%">–û—Ç–≤—è–∑–∞—Ç—å</button>
            ` : button.roomCode && button.roomCode !== roomCode ? `
              <select onchange="if(this.value) assignButton('${button.macAddress}', this.value)" style="width:100%;font-size:10px;padding:2px;border:1px solid #ccc;border-radius:3px">
                <option value="">–ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∏—Ç—å...</option>
                ${Object.values(teams).map(team => `<option value="${team.id}">${team.name}</option>`).join('')}
              </select>
            ` : `
              <select onchange="if(this.value) assignButton('${button.macAddress}', this.value)" style="width:100%;font-size:10px;padding:2px;border:1px solid #ccc;border-radius:3px">
                <option value="">–ü—Ä–∏–≤—è–∑–∞—Ç—å...</option>
                ${Object.values(teams).map(team => `<option value="${team.id}">${team.name}</option>`).join('')}
              </select>
            `}
          </div>
        </div>
      `;
    }).join('');

    $buttonsList.style.display = 'block';
  }

  // Assign button to team
  async function assignButton(macAddress, teamId) {
    if (!currentRoomCode) {
      alert('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã');
      return;
    }

    try {
      updateStatus('–ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–∫–∏...', 'connecting');
      await buttonApiRequest('/quiz/api/button/assign', {
        method: 'POST',
        body: JSON.stringify({ macAddress, roomCode: currentRoomCode, teamId }),
      });
      await loadButtons();
      updateStatus('–ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞', 'connected');
    } catch (error) {
      console.error('Failed to assign button:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ –∫–Ω–æ–ø–∫–∏: ' + error.message);
      updateStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏', 'disconnected');
    }
  }

  // Unassign button
  async function unassignButton(macAddress) {
    try {
      updateStatus('–û—Ç–≤—è–∑–∫–∞ –∫–Ω–æ–ø–∫–∏...', 'connecting');
      await buttonApiRequest('/quiz/api/button/unassign', {
        method: 'POST',
        body: JSON.stringify({ macAddress }),
      });
      await loadButtons();
      updateStatus('–ö–Ω–æ–ø–∫–∞ –æ—Ç–≤—è–∑–∞–Ω–∞', 'connected');
    } catch (error) {
      console.error('Failed to unassign button:', error);
      alert('–û—à–∏–±–∫–∞ –æ—Ç–≤—è–∑–∫–∏ –∫–Ω–æ–ø–∫–∏: ' + error.message);
      updateStatus('–û—à–∏–±–∫–∞ –æ—Ç–≤—è–∑–∫–∏', 'disconnected');
    }
  }

  // Register new button
  async function registerButton() {
    const macAddress = $buttonMac.value.trim();
    if (!macAddress) {
      alert('–í–≤–µ–¥–∏—Ç–µ MAC –∞–¥—Ä–µ—Å');
      return;
    }

    try {
      updateStatus('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏...', 'connecting');
      await buttonApiRequest('/quiz/api/button/register', {
        method: 'POST',
        body: JSON.stringify({ 
          macAddress, 
          buttonId: '1', 
          name: $buttonName.value.trim() || '' 
        }),
      });
      
      $buttonMac.value = '';
      $buttonName.value = '';
      $addButtonForm.style.display = 'none';
      await loadButtons();
      updateStatus('–ö–Ω–æ–ø–∫–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞', 'connected');
    } catch (error) {
      console.error('Failed to register button:', error);
      alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏: ' + error.message);
      updateStatus('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', 'disconnected');
    }
  }

  function showButtonPressAlert(teamName, teamId) {
    // Get team color
    let teamColor = '#3b82f6'; // Default blue
    if (currentRoomState && currentRoomState.teams && currentRoomState.teams[teamId]) {
      teamColor = currentRoomState.teams[teamId].color || teamColor;
    }
    
    // Show alert using Office.js dialog if available, otherwise use browser alert
    const message = `üîî –ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞!\n\n–ö–æ–º–∞–Ω–¥–∞: ${teamName}`;
    
    if (Office && Office.context && Office.context.ui) {
      Office.context.ui.displayDialogAsync(
        `data:text/html,<!DOCTYPE html><html><head><meta charset="UTF-8"><title>–ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞</title><style>
          body { font-family: Segoe UI, Arial; text-align: center; padding: 20px; background: linear-gradient(135deg, ${teamColor} 0%, ${teamColor}dd 100%); }
          .container { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
          h1 { margin: 0 0 20px 0; color: #333; font-size: 28px; }
          .team { background: ${teamColor}; color: white; padding: 15px 25px; border-radius: 10px; font-size: 22px; font-weight: bold; margin: 20px 0; }
          .emoji { font-size: 64px; margin-bottom: 10px; }
        </style></head><body>
          <div class="container">
            <div class="emoji">üîî</div>
            <h1>–ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞!</h1>
            <div class="team">${teamName}</div>
            <button onclick="window.close()" style="padding: 10px 25px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; margin-top: 15px;">–ü–æ–Ω—è—Ç–Ω–æ</button>
          </div>
        </body></html>`,
        { height: 50, width: 50 },
        function(result) {
          if (result.status === Office.AsyncResultStatus.Failed) {
            // Fallback to alert if dialog fails
            alert(message);
          }
        }
      );
    } else {
      // Fallback to browser alert
      alert(message);
    }
    
    console.log(`Hardware button pressed by team: ${teamName}`);
  }

  function showAnswerModal(answerData) {
    // Handle hardware button press (physical button)
    if (answerData.isHardwareButton && answerData.teamName) {
      $firstAnswerer.textContent = '–ù–∞–∂–∞—Ç–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –∫–Ω–æ–ø–∫–∞';
      $playerAnswer.textContent = '–ö–æ–º–∞–Ω–¥–∞ –æ—Ç–≤–µ—Ç–∏–ª–∞';
      
      // Show team info prominently
      const teamInfo = document.createElement('div');
      teamInfo.style.cssText = 'margin-top: 12px; padding: 12px; background: ' + 
        (currentRoomState?.teams?.[answerData.teamId]?.color || '#3b82f6') + 
        '; color: white; border-radius: 8px; font-size: 18px; font-weight: bold; text-align: center;';
      teamInfo.textContent = '–ö–æ–º–∞–Ω–¥–∞: ' + answerData.teamName;
      
      // Remove existing team info if any
      const existingTeamInfo = $answerModal.querySelector('.team-info');
      if (existingTeamInfo) {
        existingTeamInfo.remove();
      }
      
      teamInfo.className = 'team-info';
      $firstAnswerer.parentNode.insertBefore(teamInfo, $firstAnswerer.nextSibling);
      
      $pointsInput.value = 10;
      $answerModal.style.display = 'block';
      return;
    }
    
    // Handle regular player answer
    let playerName = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    let teamName = '';
    let teamColor = '';
    
    if (currentRoomState && currentRoomState.players && answerData.userId) {
      const player = currentRoomState.players[answerData.userId];
      if (player) {
        playerName = player.name || answerData.userId;
        
        // Find team for this player
        if (currentRoomState.teams) {
          for (const [teamId, team] of Object.entries(currentRoomState.teams)) {
            if (team.players.includes(answerData.userId)) {
              teamName = team.name;
              teamColor = team.color;
              break;
            }
          }
        }
      }
    }
    
    // Update modal content
    $firstAnswerer.textContent = playerName;
    $playerAnswer.textContent = answerData.answer || '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞';
    $pointsInput.value = 10; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    
    // Add team info if available
    if (teamName) {
      const teamInfo = document.createElement('div');
      teamInfo.style.cssText = 'margin-top: 8px; padding: 4px 8px; background: ' + teamColor + '; color: white; border-radius: 4px; font-size: 12px;';
      teamInfo.textContent = '–ö–æ–º–∞–Ω–¥–∞: ' + teamName;
      
      // Remove existing team info if any
      const existingTeamInfo = $answerModal.querySelector('.team-info');
      if (existingTeamInfo) {
        existingTeamInfo.remove();
      }
      
      teamInfo.className = 'team-info';
      $firstAnswerer.parentNode.insertBefore(teamInfo, $firstAnswerer.nextSibling);
    }
    
    $answerModal.style.display = 'block';
  }

  function hideAnswerModal() {
    $answerModal.style.display = 'none';
  }

  function sendAnswerConfirmation(isCorrect, points) {
    if (!ws || ws.readyState !== 1) return;
    const roomCode = currentRoomCode || $room.value.trim();
    ws.send(JSON.stringify({
      type: 'answer_confirmation',
      quizId: roomCode,
      isCorrect: isCorrect,
      points: points
    }));
    hideAnswerModal();
  }

  // Button management event handlers
  $refreshButtons.onclick = loadButtons;
  $addButtonToggle.onclick = () => {
    $addButtonForm.style.display = $addButtonForm.style.display === 'none' ? 'block' : 'none';
  };
  $addButtonConfirm.onclick = registerButton;
  $addButtonCancel.onclick = () => {
    $addButtonForm.style.display = 'none';
    $buttonMac.value = '';
    $buttonName.value = '';
  };
  
  // Make functions global for inline onclick handlers
  window.assignButton = assignButton;
  window.unassignButton = unassignButton;

  // Event handlers
  document.getElementById('connect').onclick = openWs;
  
  $createGameBtn.onclick = showCreateGameSection;
  $joinGameBtn.onclick = showJoinSection;
  $confirmCreate.onclick = createGame;
  $cancelCreate.onclick = showMainButtons;
  $backToMain.onclick = showMainButtons;
  $backToMainJoin.onclick = showMainButtons;

  // –ö–Ω–æ–ø–∫–∏ ¬´–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å/–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å¬ª ‚Äî —Ç–æ–ª—å–∫–æ WS
  $activateBtn.onclick = () => {
    // –ü–µ—Ä–µ—Ö–æ–¥ –≤ 'started' —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π => –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ 'active'
    sendHostSetState('started', 0);
  };

  $activatePlayersBtn.onclick = () => {
    // –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ñ–∞–∑—É 'active' - –∏–≥—Ä–æ–∫–∏ –º–æ–≥—É—Ç –Ω–∞–∂–∏–º–∞—Ç—å –∫–Ω–æ–ø–∫—É
    sendHostSetState('active');
  };

  $deactivateBtn.onclick = () => {
    // –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ - –≤–æ–∑–≤—Ä–∞—Ç –≤ 'started'
    sendHostSetState('started');
  };

  // –ì–æ—Ä—è—á–∏–µ WS-–∫–Ω–æ–ø–∫–∏
  document.body.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-act]');
    if (!btn) return;
    const act = btn.dataset.act;
    if (act === 'start')  sendHostSetState('started', Number(btn.dataset.delay) || 0);
    else if (act === 'active') sendHostSetState('active');
    else if (act === 'finish') sendHostSetState('finished');
    else if (act === 'reset')  sendHostSetState('lobby');
  });

  // Team management event handlers
  $createTeamBtn.onclick = createTeam;
  
  // Color selection handlers
  $teamColorBtns.forEach(btn => {
    btn.onclick = () => selectTeamColor(btn.dataset.color);
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª–∫–∏
  $answerCorrect.onclick = () => {
    const points = parseInt($pointsInput.value) || 0;
    sendAnswerConfirmation(true, points);
  };

  $answerWrong.onclick = () => {
    sendAnswerConfirmation(false, 0);
  };

  $answerCancel.onclick = () => {
    hideAnswerModal();
  };

  Office.onReady(() => {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    updateButtonStates({ phase: 'lobby' });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–≤–µ—Ç –∫–æ–º–∞–Ω–¥—ã
    selectTeamColor(selectedTeamColor);
  });
})();
</script>
</body>
</html>
